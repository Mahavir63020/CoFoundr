<!DOCTYPE html>
<html>
<head>
    <title>Solvearn MVP</title>
    <style>
        .view { display: none; }
        .view.active { display: block; }
        #notifications-panel {
            position: fixed;
            right: 10px;
            top: 60px;
            width: 300px;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .chat-message {
            padding: 8px;
            margin: 4px;
            border-radius: 4px;
        }
        .chat-message.sent {
            background: #e3f2fd;
            margin-left: 20%;
        }
        .chat-message.received {
            background: #f5f5f5;
            margin-right: 20%;
        }
    </style>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="auth-section">
        <h2>Welcome to Solvearn</h2>
        <button onclick="googleLogin()" class="google-btn">Sign In with Google</button>
    </div>

    <div id="main-app" style="display:none;">
        <header>
            <nav>
                <button onclick="showView('home')">Home</button>
                <button onclick="showView('create')">Create Project</button>
                <button onclick="showView('myProjects')">My Projects</button>
                <button onclick="showView('notifications')">Notifications</button>
                <button onclick="showView('chat')">Chat</button>
                <button onclick="logout()" class="logout-btn">Log Out</button>
            </nav>
        </header>

        <div id="notifications-panel"></div>

        <main>
            <div id="home" class="view active">
                <h2>All Projects</h2>
                <div id="project-list"></div>
            </div>

            <div id="create" class="view">
                <h2>Create a Project</h2>
                <form id="create-form" onsubmit="createProject(event)">
                    <input type="text" id="project-title" placeholder="Project Title" required><br>
                    <textarea id="project-desc" placeholder="Project Description" required></textarea><br>
                    <input type="text" id="project-roles" placeholder="Roles (comma-separated: e.g. Designer,Frontend)" required><br>
                    <button type="submit">Create Project</button>
                </form>
            </div>

            <div id="notifications" class="view">
                <h2>Notifications</h2>
                <div id="notifications-list"></div>
            </div>

            <div id="chat" class="view">
                <h2>Conversations</h2>
                <div id="chat-list"></div>
                <div id="active-chat" style="display:none;">
                    <div id="chat-messages"></div>
                    <div id="chat-input-area">
                        <input type="text" id="chat-input" placeholder="Type a message">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signOut,
            GoogleAuthProvider,
            signInWithPopup,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            onSnapshot,
            query,
            where,
            doc,
            updateDoc,
            arrayUnion,
            serverTimestamp,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC_wK8NlJw-yUvsqKkBFxBP1GdzqEbzWP8",
            authDomain: "solvearn-mvp-a00f1.firebaseapp.com",
            projectId: "solvearn-mvp-a00f1",
            storageBucket: "solvearn-mvp-a00f1.firebasestorage.app",
            messagingSenderId: "71657733409",
            appId: "1:71657733409:web:1db68c51393ecd7dfc5260",
            measurementId: "G-NJGT0SJ2TP"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // User Management
        async function handleUserProfile(user) {
            const userRef = doc(db, "users", user.uid);
            await updateDoc(userRef, {
                name: user.displayName,
                email: user.email,
                photoURL: user.photoURL,
                lastLogin: serverTimestamp()
            }, { merge: true });
        }

        window.googleLogin = async function() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                await handleUserProfile(result.user);
            } catch (error) {
                alert("Login error: " + error.message);
            }
        };

        window.logout = () => signOut(auth);

        // Project Management
        window.createProject = async function(e) {
            e.preventDefault();
            const project = {
                title: document.getElementById("project-title").value,
                description: document.getElementById("project-desc").value,
                roles: document.getElementById("project-roles").value.split(",").map(r => ({
                    title: r.trim(),
                    filled: false,
                    applicants: []
                })),
                createdBy: auth.currentUser.uid,
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "projects"), project);
                alert("Project created!");
                showView('home');
            } catch (err) {
                alert("Error: " + err.message);
            }
        };

        // Application System
        window.applyForRole = async function(projectId, roleIndex) {
            const application = {
                projectId,
                applicantId: auth.currentUser.uid,
                roleIndex,
                status: "pending",
                createdAt: serverTimestamp()
            };

            await addDoc(collection(db, "applications"), application);
            await addDoc(collection(db, "notifications"), {
                recipientId: projectCreatorId,
                type: "application",
                projectId,
                applicantId: auth.currentUser.uid,
                roleIndex,
                read: false,
                createdAt: serverTimestamp()
            });
        };

        // Notifications
        function setupNotifications() {
            const notificationsQuery = query(
                collection(db, "notifications"),
                where("recipientId", "==", auth.currentUser.uid)
            );

            onSnapshot(notificationsQuery, (snapshot) => {
                const notifications = [];
                snapshot.forEach(doc => {
                    notifications.push({ id: doc.id, ...doc.data() });
                });
                renderNotifications(notifications);
            });
        }

        // Chat System
        function setupChat() {
            const chatsQuery = query(
                collection(db, "chats"),
                where("participants", "array-contains", auth.currentUser.uid)
            );

            onSnapshot(chatsQuery, (snapshot) => {
                const chats = [];
                snapshot.forEach(doc => {
                    chats.push({ id: doc.id, ...doc.data() });
                });
                renderChats(chats);
            });
        }

        window.sendMessage = async function() {
            const message = document.getElementById("chat-input").value;
            const activeChatId = document.getElementById("active-chat").dataset.chatId;
            
            await addDoc(collection(db, `chats/${activeChatId}/messages`), {
                text: message,
                senderId: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
        };

        // View Management
        window.showView = function(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        };

        // Auth State Observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById("auth-section").style.display = "none";
                document.getElementById("main-app").style.display = "block";
                handleUserProfile(user);
                setupNotifications();
                setupChat();
            } else {
                document.getElementById("auth-section").style.display = "block";
                document.getElementById("main-app").style.display = "none";
            }
        });
    </script>
</body>
</html>
